<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë„ˆì§€ ì ˆê° ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- ìƒë‹¨ íƒ­ ë§í¬ -->
<nav class="top-links">
    <a href="/">ì‹œê°„ì¶• ì˜ˆì¸¡</a>
    <a href="/compare">ë…¸í›„ë„ë³„ ì˜ˆì¸¡ ë¹„êµ</a>
</nav>

<form id="simFilterForm" method="get" action="/simulator"
      class="d-flex flex-wrap gap-3 mb-2">

    <div class="filter-item">
        <label for="house_type" class="form-label">ì£¼íƒ ìœ í˜•</label>
        <select id="house_type" name="house_type" onchange="this.form.submit()">
            {% for h in house_types %}
                <option value="{{ h }}" {% if h == selected_house %}selected{% endif %}>{{ h }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-item">
        <label for="age_group" class="form-label">ë…¸í›„ë„ ê·¸ë£¹</label>
        <select id="age_group" name="age_group" onchange="this.form.submit()">
            {% for g in age_groups %}
                <option value="{{ g }}" {% if g == selected_age %}selected{% endif %}>{{ g }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-item">
        <label for="metric" class="form-label">ì§€í‘œ ì„ íƒ</label>
        <select id="metric" name="metric" onchange="this.form.submit()">
            {% for key, val in metric_labels.items() %}
                <option value="{{ key }}" {% if key == selected_metric %}selected{% endif %}>{{ val }}</option>
            {% endfor %}
        </select>
    </div>
</form>

<hr>

{% if series %}
    <div>
        <label>ì ˆê°ë¥ : <span id="savingLabel">10</span>%</label><br>
        <input type="range" id="savingSlider" min="0" max="50" value="10" step="1">
    </div>

    <div id="chart" style="width: 100%; height: 380px;"></div>

    <script>
        const histDates = {{ series.hist_dates | tojson }};
        const histValues = {{ series.hist_values | tojson }};
        const futDates  = {{ series.fut_dates  | tojson }};
        const futValues = {{ series.fut_values | tojson }};

        const baseFuture = futValues.slice();  // ì›ë³¸ ì˜ˆì¸¡ê°’
        let savingRate = 0.10;  // ì´ˆê¸° ì ˆê°ë¥  10%

        function getReducedFuture() {
            return baseFuture.map(v => v * (1 - savingRate));
        }

        function drawChart(initial = true) {
            const reducedFuture = getReducedFuture();

            // ğŸ”— ì‹œê°„ì¶•ì„ "ì‹¤ì œ + ë¯¸ë˜"ë¡œ í•˜ë‚˜ë¡œ ì´ì–´ì„œ ì‚¬ìš©
            const baseX = histDates.concat(futDates);
            const baseY = histValues.concat(baseFuture);
            const reducedY = histValues.concat(reducedFuture);

            const traceHist = {
                x: histDates,
                y: histValues,
                mode: "lines",
                name: "ì‹¤ì œ",
                line: {dash: "solid"}
            };

            const traceBase = {
                x: baseX,
                y: baseY,
                mode: "lines",
                name: "ì˜ˆì¸¡(ê¸°ì¤€)",
                line: {dash: "dot"}
            };

            const traceReduced = {
                x: baseX,
                y: reducedY,
                mode: "lines",
                name: "ì˜ˆì¸¡(ì ˆê° ì ìš©)",
                line: {dash: "dash"}
            };

            const layout = {
                title: "{{ selected_house }} / {{ selected_age }} â€“ {{ metric_labels[selected_metric] }} ì ˆê° ì‹œë®¬ë ˆì´ì…˜",
                xaxis: {title: "ì›”"},
                yaxis: {title: "{{ metric_labels[selected_metric] }}"},
                legend: {orientation: "h", x: 0, y: 1.15}
            };

            if (initial) {
                Plotly.newPlot("chart", [traceHist, traceBase, traceReduced], layout);
            } else {
                Plotly.update("chart", {
                    x: [histDates, baseX, baseX],
                    y: [histValues, baseY, reducedY]
                }, {}, [0, 1, 2]);
            }
        }

        // ì´ˆê¸° ê·¸ë¦¬ê¸°
        drawChart(true);

        const slider = document.getElementById("savingSlider");
        const label  = document.getElementById("savingLabel");

        slider.addEventListener("input", function() {
            label.textContent = this.value;
            savingRate = parseFloat(this.value) / 100.0;
            drawChart(false);
        });
    </script>
{% else %}
    <p>í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

</body>
</html>
