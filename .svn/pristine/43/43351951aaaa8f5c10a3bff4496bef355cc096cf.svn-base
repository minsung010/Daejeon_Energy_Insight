// --- ì „ì—­ ë³€ìˆ˜ ---
console.log('Script.js ë¡œë“œë¨');
var map = null;
var _lastState = { id: '', type: '', layer: '', coords: '' };
var _highlightTimeout = null;
var _HIGHLIGHT_DELAY = 120;
var DEBUG = true;
var VWORLD_API_KEY = '3907B382-CD3D-304B-A82F-C7BFA4286232'; // (ì°¸ê³ ìš©)
var _lastAddressRequestId = 0;
const _dataCache = new Map();

var searchMarkers = [];
// âœ… ë§ˆì»¤ ì´ë¯¸ì§€/í¬ê¸°/ê°œìˆ˜ ì„¤ì •
const SEARCH_MARKER_IMAGE = '/map_img/search-pin.png';
const SEARCH_MARKER_SIZE = { w: 24, h: 24 };   // ğŸ‘ˆ ë” ì‘ê²Œ
const SEARCH_MAX_MARKERS = 1;                  // ğŸ‘ˆ í•­ìƒ 1ê°œë§Œ ì°ê¸°
const DEDUPE_EPS = 0.0005;                     // ì¢Œí‘œ ì¤‘ë³µ ì œê±°(ì•½ ~50m)

// ìœ í‹¸
function $id(id) { return document.getElementById(id); }
function escapeHtml(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// --- POI í´ë°± (VWorld req/search) ---
async function fallbackPoiSearch(keyword) {
  try {
    const params = new URLSearchParams({
      query: keyword,
      size: '1',          // ğŸ‘ˆ ì„œë²„ì—ì„œë„ 1ê°œë§Œ ìš”ì²­
      page: '1',
      type: 'place',
      category: 'POI',
      domain: 'poi'
    });

    const response = await fetch(`/api/search_address?${params.toString()}`);
    if (!response.ok) return null;

    const data = await response.json();
    if (data?.error) {
      console.warn('POI ê²€ìƒ‰ í”„ë¡ì‹œ ì˜¤ë¥˜:', data.error);
      return null;
    }

    const items = data?.response?.result?.items;
    if (!Array.isArray(items) || !items.length) return null;

    const first = items[0];
    if (!first?.point) return null;

    const lon = Number(first.point.x);
    const lat = Number(first.point.y);
    if (!isFinite(lon) || !isFinite(lat)) return null;

    const addr = first.address || {};
    const road = addr.road || addr.roadAddress || '';
    const parcel = addr.parcel || addr.parcelAddress || '';
    const full = addr.full || first.title || [road, parcel].filter(Boolean).join(' ') || keyword;

    return {
      point: { x: lon, y: lat },
      title: first.title || keyword,
      address: { road, parcel, full }
    };
  } catch (e) {
    console.error('POI fallback ì˜¤ë¥˜:', e);
    return null;
  }
}

// --- ì§€ë„ ì´ˆê¸°í™” (ê°„ë‹¨ ë²„ì „) ---
function initializeMap() {
  console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘...');
  if (typeof vw === 'undefined' || !vw.Map) {
    console.error('VWorld APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return false;
  }

  try {
    // ê¸°ì¡´ ì§€ë„ ì œê±°
    if (window.map) {
      if (typeof window.map.destroy === 'function') window.map.destroy();
      else if (typeof window.map.dispose === 'function') window.map.dispose();
      window.map = null;
      map = null;
    }

    var defaultLon = 127.3845;
    var defaultLat = 36.3504;
    var defaultHeight = 20000;

    var options = {
      mapId: 'vmap',
      initPosition: new vw.CameraPosition(
        new vw.CoordZ(defaultLon, defaultLat, 2000),
        new vw.Direction(0, -90, 0)
      ),
      logo: true,
      navigation: true
    };

    var newMap = new vw.Map();
    newMap.setOption(options);
    newMap.setMapId('vmap');
    newMap.setInitPosition(
      new vw.CameraPosition(
        new vw.CoordZ(defaultLon, defaultLat, defaultHeight),
        new vw.Direction(0, -90, 0)
      )
    );

    newMap.setLogoVisible(true);
    newMap.setNavigationZoomVisible(true);
    newMap.start();

    map = newMap;
    window.map = newMap;

    console.log('âœ… ì§€ë„ ìƒì„± ì™„ë£Œ!');
    // í´ë¦­ í•¸ë“¤ëŸ¬ ë¶€ì°©
    setTimeout(attachClickHandler, 1000);
    return true;
  } catch (e) {
    console.error('ì§€ë„ ìƒì„± ì˜¤ë¥˜:', e);
    return false;
  }
}

// --- í´ë¦­ í•¸ë“¤ëŸ¬ ë¶€ì°© ---
function attachClickHandler() {
  var attempts = 0;
  var interval = setInterval(function() {
    attempts++;
    if (!map) map = window.map;

    if (map) {
      var attached = false;

      if (map.onClick && typeof map.onClick.addEventListener === 'function') {
        try { map.onClick.addEventListener(buildingInfoEvent); attached = true; }
        catch (e) { console.error('í´ë¦­ ì´ë²¤íŠ¸ ë¶€ì°© ì‹¤íŒ¨(onClick):', e); }
      } else if (typeof map.addEventListener === 'function') {
        try {
          var clickEvent = (vw && vw.EventType && vw.EventType.CLICK) ? vw.EventType.CLICK : 'click';
          map.addEventListener(clickEvent, buildingInfoEvent); attached = true;
        } catch (e) { console.error('í´ë¦­ ì´ë²¤íŠ¸ ë¶€ì°© ì‹¤íŒ¨(addEventListener):', e); }
      } else if (map.getEventManager && typeof map.getEventManager === 'function') {
        try {
          var manager = map.getEventManager();
          if (manager && typeof manager.addEventListener === 'function') {
            var managerClickEvent = (vw && vw.EventType && vw.EventType.CLICK) ? vw.EventType.CLICK : 'click';
            manager.addEventListener(managerClickEvent, buildingInfoEvent); attached = true;
          }
        } catch (e) { console.error('í´ë¦­ ì´ë²¤íŠ¸ ë¶€ì°© ì‹¤íŒ¨(eventManager):', e); }
      }

      if (attached) { clearInterval(interval); console.log('âœ… í´ë¦­ ì´ë²¤íŠ¸ ë¶€ì°© ì™„ë£Œ!'); return; }
    }

    if (attempts >= 50) { clearInterval(interval); console.error('í´ë¦­ í•¸ë“¤ëŸ¬ íƒ€ì„ì•„ì›ƒ'); }
  }, 200);
}

// --- í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
var buildingInfoEvent = function(windowPosition, ecefPosition, cartographic, modelObject) {
  try {
    if (!modelObject) return;
    var mapElement = modelObject.element;
    var attributes = modelObject.attributes;
    if (!attributes || !mapElement) return;

    // ì‚¬ì´ë“œë°” ì—´ê¸°
    const sidebar = $id('mapSidebar');
    if (sidebar && !sidebar.classList.contains('open')) sidebar.classList.add('open');

    debouncedHighlight(mapElement, attributes);

    var coordsStr = formatCartographic(cartographic) || '';
    var numericCoords = extractLonLat(cartographic);
    var bIdVal = attributes.MODEL_NAME || '';

    if (bIdVal !== _lastState.id || coordsStr !== _lastState.coords) {
      _lastState.id = bIdVal;
      _lastState.coords = coordsStr;

      ensureSidebarOpen();
      prepareSidebarForData(bIdVal);

      if (numericCoords && isFinite(numericCoords.lon) && isFinite(numericCoords.lat)) {
        requestRoadAddressAndData(numericCoords.lon, numericCoords.lat, bIdVal);
      }
    }
  } catch (e) {
    console.error('buildingInfoEvent error', e);
  }
};

// --- ì§€ë„ ì•ˆ ì‚¬ì´ë“œë°” í† ê¸€ ---
function initMapSidebar() {
  const toggleBtn = $id('toggleMapSidebar');
  const sidebar = $id('mapSidebar');
  if (toggleBtn && sidebar) {
    toggleBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      sidebar.classList.toggle('open');
    });
  }
}

// --- ì§€ì—­/ì£¼ì†Œ/POI ê²€ìƒ‰ ---
function initRegionSearch() {
  bindSearchControls('regionSearchInput', 'regionSearchBtn'); // ê³µìš©(ì¢Œì¸¡) ê²€ìƒ‰ì°½ ì“´ë‹¤ë©´
  bindSearchControls('mapSearchInput', 'mapSearchBtn');       // ì§€ë„ ë‚´ë¶€ ê²€ìƒ‰ì°½
}

function bindSearchControls(inputId, buttonId) {
  const inputEl = $id(inputId);
  const buttonEl = $id(buttonId);
  if (!inputEl || !buttonEl) return;

  const run = () => performRegionSearch(inputEl);
  buttonEl.type = 'button'; // í¼ submit ë°©ì§€
  buttonEl.addEventListener('click', run);
  inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') run(); });
}

async function performRegionSearch(inputEl) {
  const keyword = (inputEl?.value || '').trim();
  if (!keyword) {
    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  await searchRegionAndDisplayResults(keyword);
}

async function searchRegionAndDisplayResults(keyword) {
  const targetMap = map || window.map;
  if (!targetMap) {
    alert('ì§€ë„ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }

  clearSearchMarkers();

  // 1) ì£¼ì†Œ ìš°ì„  íƒìƒ‰(ì„œë²„ì—ì„œë¶€í„° 1ê°œë§Œ)
  const addrParams = new URLSearchParams({
    query: keyword,
    size: '1',       // ğŸ‘ˆ í•œ ê±´ë§Œ
    page: '1',
    type: 'address'
  });
  let items = await callVworldSearch(addrParams);

  // 2) ì£¼ì†Œê°€ ë¹„ì–´ ìˆìœ¼ë©´ POI(ì¥ì†Œ)ë¡œ í´ë°±(ì—­/ëŒ€í•™ ë“±)
  if (!items || items.length === 0) {
    const poiParams = new URLSearchParams({
      query: keyword,
      size: '1',     // ğŸ‘ˆ í•œ ê±´ë§Œ
      page: '1',
      type: 'place'
    });
    items = await callVworldSearch(poiParams);
  }

  // 3) ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì§€ì˜¤ì½”ë”© í´ë°±
  if (!items || items.length === 0) {
    const fallbackItem = await fallbackGeocodeSearch(keyword);
    if (fallbackItem) {
      focusMapToSearchResult(targetMap, fallbackItem);
      presentSearchResult(fallbackItem, keyword);
      renderSearchMarkers(targetMap, [fallbackItem]); // í•œ ê±´
      ensureSidebarOpen();
      return;
    }
    alert('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ì¢Œí‘œ ì¤‘ë³µ ì œê±° + ìµœëŒ€ 1ê±´ ì œí•œ
  items = dedupeByCoord(items, DEDUPE_EPS).slice(0, SEARCH_MAX_MARKERS);

  // ì„±ê³µ: ì¹´ë©”ë¼ ì´ë™ + ë§ˆì»¤ + ì‚¬ì´ë“œíŒ¨ë„ í‘œì‹œ
  focusMapToSearchResult(targetMap, items[0]);
  presentSearchResult(items[0], keyword);
  renderSearchMarkers(targetMap, items);
  ensureSidebarOpen();
}

async function callVworldSearch(params) {
  try {
    const res = await fetch(`/api/search_address?${params.toString()}`);
    if (!res.ok) {
      console.warn('search_address HTTP ì˜¤ë¥˜', res.status);
      return [];
    }
    const json = await res.json();
    if (json?.response?.status === 'OK') {
      return json?.response?.result?.items || [];
    }
    if (json?.error) {
      console.warn('VWorld ê²€ìƒ‰ API ì—ëŸ¬:', json.error);
    }
  } catch (e) {
    console.error('VWorld ê²€ìƒ‰ í˜¸ì¶œ ì‹¤íŒ¨:', e);
  }
  return [];
}

function dedupeByCoord(items, eps) {
  const seen = [];
  const out = [];
  for (const it of items) {
    const x = Number(it?.point?.x);
    const y = Number(it?.point?.y);
    if (!isFinite(x) || !isFinite(y)) continue;
    let dup = false;
    for (const [sx, sy] of seen) {
      if (Math.abs(x - sx) <= eps && Math.abs(y - sy) <= eps) { dup = true; break; }
    }
    if (!dup) {
      seen.push([x, y]);
      out.push(it);
    }
  }
  return out;
}

function clearSearchMarkers() {
  if (Array.isArray(searchMarkers) && searchMarkers.length) {
    searchMarkers.forEach(m => { try { m?.destroy?.(); } catch(e){} });
  }
  searchMarkers = [];
}

function focusMapToSearchResult(targetMap, item) {
  if (!item?.point) return;
  const lon = Number(item.point.x);
  const lat = Number(item.point.y);
  if (!isFinite(lon) || !isFinite(lat)) return;

  const cameraPosition = new vw.CameraPosition(
    new vw.CoordZ(lon, lat, 1500),
    new vw.Direction(0, -90, 0)
  );
  if (typeof targetMap.moveTo === 'function') targetMap.moveTo(cameraPosition);

  const cam = targetMap.getCamera && targetMap.getCamera();
  if (cam?.setPositionAndRotation) cam.setPositionAndRotation(cameraPosition);

  map = targetMap;
}

function renderSearchMarkers(targetMap, items) {
  if (!Array.isArray(items)) return;

  items.forEach((item, i) => {
    const mx = Number(item.point?.x);
    const my = Number(item.point?.y);
    if (!isFinite(mx) || !isFinite(my)) return;

    const point = new vw.geom.Point(new vw.Coord(mx, my));

    // âœ… ë§ˆì»¤ ì´ë¯¸ì§€ë¥¼ í•œ ë²ˆë§Œ ì„¤ì • + ì‘ì€ í¬ê¸°
    point.setImage(SEARCH_MARKER_IMAGE + '?v=20251112', SEARCH_MARKER_SIZE.w, SEARCH_MARKER_SIZE.h);

    point.setName(item.title || `ê²€ìƒ‰ê²°ê³¼ ${i + 1}`);
    point.setId('search_marker_' + i);
    point.setFont('ê³ ë”•');
    point.setFontSize(14);

    const road = item.address?.road || item.address?.roadAddress || '';
    const parcel = item.address?.parcel || item.address?.parcelAddress || '';
    const full = item.address?.full || road || parcel || item.title || '';

    point.set('road', road);
    point.set('parcel', parcel);
    point.set('full', full);
    if (!item.address) item.address = {};
    if (!item.address.full) item.address.full = full;

    point.create();

    point.addEventListener((windowPosition, _ecef, _carto, featureInfo) => {
      if (!featureInfo) return;
      const markerObj = targetMap.getObjectById(featureInfo.groupId);
      if (!markerObj) return;

      const road = markerObj.get('road');
      const parcel = markerObj.get('parcel');
      const full = markerObj.get('full');
      const title = markerObj.getName();

      presentSearchResult({
        point: { x: mx, y: my },
        title,
        address: { road, parcel, full }
      }, title);
    });

    searchMarkers.push(point);
  });
}

function ensureSidebarOpen() {
  const sidebar = $id('mapSidebar');
  if (sidebar && !sidebar.classList.contains('open')) sidebar.classList.add('open');
}

function prepareSidebarForData() {
  requestAnimationFrame(function() {
    const addressEl = $id('sidebar_address');
    const ageEl = $id('sidebar_age');
    const purposeEl = $id('sidebar_purpose');
    const roadEl = $id('sidebar_road');

    if (addressEl) addressEl.textContent = 'ì¡°íšŒ ì¤‘...';
    if (ageEl) ageEl.textContent = 'ì¡°íšŒ ì¤‘...';
    if (purposeEl) purposeEl.textContent = 'ì¡°íšŒ ì¤‘...';
    if (roadEl) roadEl.textContent = '-';
  });
}

function presentSearchResult(item, keyword) {
  if (!item) return;

  const lon = Number(item?.point?.x);
  const lat = Number(item?.point?.y);
  if (!isFinite(lon) || !isFinite(lat)) return;

  const label = item?.title || keyword || 'ê²€ìƒ‰ ê²°ê³¼';
  ensureSidebarOpen();
  prepareSidebarForData();
  updateSidebarWithSearchItem(item, keyword);

  requestRoadAddressAndData(lon, lat, label);
}

function updateSidebarWithSearchItem(item, keyword) {
  const full = item?.address?.full || item?.title || keyword || '';

  const addressEl = $id('sidebar_address');
  if (addressEl && full) addressEl.textContent = full;

  const roadEl = $id('sidebar_road');
  if (roadEl) {
    const roadDetail = item?.address?.full || [item?.address?.road, item?.address?.parcel]
      .filter(Boolean)
      .join(' ');
    roadEl.textContent = roadDetail || '-';
  }
}

function buildSidebarDetail(structure, firstResult, fallback) {
  const parts = [];
  const push = v => {
    if (!v) return;
    const t = String(v).trim();
    if (t && !parts.includes(t)) parts.push(t);
  };

  const candidate = firstResult?.structure || {};
  push(structure?.level4L || structure?.level4LC || candidate.level4L || candidate.level4LC);
  push(structure?.level5 || candidate.level5);
  push(structure?.level6 || candidate.level6);
  push(structure?.detail || candidate.detail);
  push(firstResult?.detail);

  if (parts.length === 0 && fallback) push(fallback);
  return parts.join(' ').trim();
}

function updateSidebarWithAddress(response, fallbackRoadAddress) {
  const refined = response?.refined || {};
  const results = response?.result;
  const firstResult = Array.isArray(results) ? results[0] : results;
  const structure = refined.structure || firstResult?.structure || {};
  const fullText = refined.text || firstResult?.text || fallbackRoadAddress;

  const addressEl = $id('sidebar_address');
  if (addressEl) addressEl.textContent = fullText || fallbackRoadAddress || 'ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

  const roadEl = $id('sidebar_road');
  if (roadEl) {
    const detail = buildSidebarDetail(structure, firstResult, fallbackRoadAddress);
    roadEl.textContent = detail || fullText || fallbackRoadAddress || '-';
  }
}

async function fallbackGeocodeSearch(keyword) {
  try {
    const params = new URLSearchParams({ query: keyword });
    const response = await fetch(`/api/geocode?${params.toString()}`);
    if (!response.ok) return null;

    const data = await response.json();
    if (data?.error) {
      console.warn('ì§€ì˜¤ì½”ë”© í”„ë¡ì‹œ ì˜¤ë¥˜:', data.error);
      return null;
    }

    const result = data?.response?.result;
    const first = Array.isArray(result) ? result[0] : result;
    if (!first?.point) return null;

    const lon = Number(first.point.x);
    const lat = Number(first.point.y);
    if (!isFinite(lon) || !isFinite(lat)) return null;

    const structure = first.structure || {};
    const road = structure.level4L || structure.level4LC || '';
    const parcel = structure.level5 || structure.level6 || '';
    const full = first.text || [road, parcel].filter(Boolean).join(' ') || keyword;

    return {
      point: { x: lon, y: lat },
      title: first.text || keyword,
      address: { road, parcel, full }
    };
  } catch (e) {
    console.error('Geocode fallback ì˜¤ë¥˜:', e);
    return null;
  }
}

// --- ì£¼ì†Œ ë° ë°ì´í„° ì¡°íšŒ ---
function requestRoadAddressAndData(lon, lat, buildingId) {
  if (!lon || !lat) return;

  var url = `/api/get_address?lon=${Number(lon).toFixed(9)}&lat=${Number(lat).toFixed(9)}`;
  var requestId = ++_lastAddressRequestId;

  fetch(url)
    .then(res => res.ok ? res.json() : Promise.reject('HTTP ' + res.status))
    .then(data => {
      if (requestId !== _lastAddressRequestId) return;

      let roadAddress = '';
      const responsePayload = data && data.response;
      if (responsePayload && responsePayload.status === 'OK') {
        const result = responsePayload.result;
        if (Array.isArray(result) && result.length > 0) {
          const firstResult = result[0];
          roadAddress = firstResult.text || firstResult.structure?.text || '';
        } else if (result && typeof result === 'object') {
          roadAddress = result.text || '';
        }
      }

      const addressEl = $id('sidebar_address');
      if (addressEl) addressEl.textContent = roadAddress || 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

      updateSidebarWithAddress(responsePayload, roadAddress);
      fetchBuildingData(lon, lat, buildingId);
    })
    .catch(err => {
      if (requestId !== _lastAddressRequestId) return;
      const addressEl = $id('sidebar_address');
      if (addressEl) addressEl.textContent = 'ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨';
      resetSidebarAdminFields();
    });
}

async function fetchBuildingData(lon, lat, buildingId) {
  try {
    const eproData = await fetchDataFromCoords(lon, lat);

    let eproAge = 'ì •ë³´ ì—†ìŒ';
    let eproPurpose = 'ì •ë³´ ì—†ìŒ';
    let eproHeight = 'ì •ë³´ ì—†ìŒ';
    let eproStructure = 'ì •ë³´ ì—†ìŒ';
    let eproFloors = 'ì •ë³´ ì—†ìŒ';

    if (eproData) {
      const age = eproData.BULD_SPANU_NUM ?? eproData.AVG_AGE;
      if (age != null && age !== '') eproAge = `${parseFloat(age).toFixed(1)} ë…„`;
      eproPurpose = eproData.BILD_PRPOS || eproData.BUILDING_TYPE || 'ì •ë³´ ì—†ìŒ';
      eproHeight = eproData.BULD_HEIGHT ? `${eproData.BULD_HEIGHT} m` : 'ì •ë³´ ì—†ìŒ';
      eproStructure = eproData.STRCT_TY_NM || 'ì •ë³´ ì—†ìŒ';
      eproFloors = eproData.GRD_FLR_CNT ? `${eproData.GRD_FLR_CNT} ì¸µ` : 'ì •ë³´ ì—†ìŒ';
    }

    const ageEl = $id('sidebar_age');
    const purposeEl = $id('sidebar_purpose');
    const heightEl = $id('sidebar_height');
    const structureEl = $id('sidebar_structure');
    const floorsEl = $id('sidebar_floors');

    if (ageEl) ageEl.textContent = eproAge;
    if (purposeEl) purposeEl.textContent = eproPurpose;
    if (heightEl) heightEl.textContent = eproHeight;
    if (structureEl) structureEl.textContent = eproStructure;
    if (floorsEl) floorsEl.textContent = eproFloors;
  } catch (e) {
    console.error('fetchBuildingData error', e);
    const ageEl = $id('sidebar_age');
    const purposeEl = $id('sidebar_purpose');
    const heightEl = $id('sidebar_height');
    const structureEl = $id('sidebar_structure');
    const floorsEl = $id('sidebar_floors');

    if (ageEl) ageEl.textContent = 'ì •ë³´ ì—†ìŒ';
    if (purposeEl) purposeEl.textContent = 'ì •ë³´ ì—†ìŒ';
    if (heightEl) heightEl.textContent = 'ì •ë³´ ì—†ìŒ';
    if (structureEl) structureEl.textContent = 'ì •ë³´ ì—†ìŒ';
    if (floorsEl) floorsEl.textContent = 'ì •ë³´ ì—†ìŒ';
  }
}

async function fetchDataFromCoords(lon, lat) {
  try {
    const key = `${lon.toFixed(6)},${lat.toFixed(6)}`;
    if (_dataCache.has(key)) return _dataCache.get(key);

    const res = await fetch(`/api/get-data-from-coords?lon=${lon}&lat=${lat}`);
    if (!res.ok) return null;

    const json = await res.json();
    if (json.status === 'OK' && json.data) {
      _dataCache.set(key, json.data);
      return json.data;
    }
    return null;
  } catch (e) {
    return null;
  }
}

// --- í•˜ì´ë¼ì´íŠ¸ & ì¢Œí‘œ ìœ í‹¸ ---
function debouncedHighlight(mapElement, attributes) {
  if (_highlightTimeout) clearTimeout(_highlightTimeout);
  _highlightTimeout = setTimeout(function() {
    try { if (mapElement && typeof mapElement.highlightFeatureByKey === 'function') mapElement.highlightFeatureByKey(attributes); }
    catch (e) {}
  }, _HIGHLIGHT_DELAY);
}

function formatCartographic(cartographic) {
  if (!cartographic) return '';
  var lon, lat, h;

  if (Array.isArray(cartographic)) { lon = cartographic[0]; lat = cartographic[1]; h = cartographic[2]; }
  else if (typeof cartographic === 'object') {
    lon = cartographic.longitude || cartographic.lon || cartographic.x;
    lat = cartographic.latitude || cartographic.lat || cartographic.y;
    h = cartographic.height || cartographic.z;
  }

  function toDegOrKeep(v) {
    if (v == null || !isFinite(v)) return null;
    return Math.abs(v) <= 2 * Math.PI ? (v * 180 / Math.PI).toFixed(6) : Number(v).toFixed(6);
  }

  var lonD = toDegOrKeep(lon);
  var latD = toDegOrKeep(lat);
  if (!lonD || !latD) return '';
  return lonD + ', ' + latD + (h ? (' (h:' + Number(h).toFixed(2) + ')') : '');
}

function extractLonLat(cartographic) {
  if (!cartographic) return null;
  var lon, lat, h;

  if (Array.isArray(cartographic)) { lon = cartographic[0]; lat = cartographic[1]; h = cartographic[2]; }
  else if (typeof cartographic === 'object') {
    lon = cartographic.longitude || cartographic.lon || cartographic.x;
    lat = cartographic.latitude || cartographic.lat || cartographic.y;
    h = cartographic.height || cartographic.z;
  }

  if (lon == null || lat == null) return null;

  function toDeg(v) {
    if (v == null || !isFinite(v)) return null;
    return Math.abs(v) <= 2 * Math.PI ? v * 180 / Math.PI : v;
  }

  return { lon: toDeg(lon), lat: toDeg(lat), height: (h != null && isFinite(h)) ? Number(h) : null };
}

// --- í˜ì´ì§€ ë¡œë“œ ---
window.addEventListener('load', function() {
  console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
  initMapSidebar();
  initRegionSearch();

  // VWorld API ëŒ€ê¸°
  var attempts = 0;
  var interval = setInterval(function() {
    attempts++;
    if (typeof vw !== 'undefined' && typeof vw.Map === 'function') {
      clearInterval(interval);
      console.log('VWorld API ë¡œë“œ ì™„ë£Œ');
      setTimeout(function() { initializeMap(); }, 500);
    } else if (attempts >= 50) {
      clearInterval(interval);
      console.error('VWorld API ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
      alert('ì§€ë„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    }
  }, 200);
});
